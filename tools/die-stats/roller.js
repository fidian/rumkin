"use strict";function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function _createForOfIteratorHelper(t,e){var r,n,o,i,s="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(s)return n=!(r=!0),{s:function(){s=s.call(t)},n:function(){var t=s.next();return r=t.done,t},e:function(t){n=!0,o=t},f:function(){try{r||null==s.return||s.return()}finally{if(n)throw o}}};if(Array.isArray(t)||(s=_unsupportedIterableToArray(t))||e&&t&&"number"==typeof t.length)return s&&(t=s),i=0,{s:e=function(){},n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:e};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,e){var r;if(t)return"string"==typeof t?_arrayLikeToArray(t,e):"Map"===(r="Object"===(r=Object.prototype.toString.call(t).slice(8,-1))&&t.constructor?t.constructor.name:r)||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(t,e):void 0}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=t[r];return n}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,_toPropertyKey(n.key),n)}}function _createClass(t,e,r){return e&&_defineProperties(t.prototype,e),r&&_defineProperties(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}function _toPropertyKey(t){t=_toPrimitive(t,"string");return"symbol"===_typeof(t)?t:String(t)}function _toPrimitive(t,e){if("object"!==_typeof(t)||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0===r)return("string"===e?String:Number)(t);r=r.call(t,e||"default");if("object"!==_typeof(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}var Rolls=require("./rolls");module.exports=function(){function t(){_classCallCheck(this,t),this.callback=null,this.statusCallback=null,this.startingStepCount=0,this.currentStepNumber=0,this.steps=[],this.timeout=null,this.results=[]}return _createClass(t,[{key:"status",value:function(t){this.statusCallback(t.message)}},{key:"calculate",value:function(t,e,r){this.timeout&&(clearTimeout(this.timeout),this.timeout=null),this.callback=e,this.statusCallback=r,this.steps=[],this.results=this.createSteps(t),this.scheduleNextStep()}},{key:"hasDropsOrPenalties",value:function(t){return t.drop||t.penalty}},{key:"dropPenaltyBonus",value:function(t,e){var o,i,s;return this.hasDropsOrPenalties?((o=t.fork()).adjustBonus(e.bonus+t.getBonus()),i=e.drop||0,s=e.penalty||0,t.forEach(function(t,e){for(var r=0;r<i;r+=1)t.shift();for(var n=0;n<s;n+=1)t.pop();o.add(t,e)}),o):(t.adjustBonus(e.bonus),t)}},{key:"createSteps",value:function(t){var e,r=[],n=_createForOfIteratorHelper(t);try{for(n.s();!(e=n.n()).done;){var o=e.value;o.roll?this.createStepsSubgroup(r,o):this.createStepsDieRoll(r,o)}}catch(t){n.e(t)}finally{n.f()}return r}},{key:"createStepsSubgroup",value:function(e,r){var n,o=this,t=this.createSteps(r.roll);this.addStep("Merging group",function(){n=o.combineRolls(t)}),this.addStep("Handling drops, penalties, and bonuses",function(){var t=o.dropPenaltyBonus(n,r);e.push(t)})}},{key:"rollDie",value:function(t){for(var e=new Rolls,r=1;r<=t;r+=1)e.add([r],1);return e}},{key:"createStepsDieRoll",value:function(e,r){var n=this,o=[],t=r.die.sides,i=r.die.number;this.addStep("Rolling dice: ".concat(i,"d").concat(t),function(){for(;o.length<i;)o.push(n.rollDie(r.die.sides))});for(var s=1;s<i;s+=1)this.addStep("Merging ".concat(s,"d").concat(t," into ").concat(s+1,"d").concat(t),function(){var t=o.shift(),e=o.shift(),t=t.mergeWith(e);n.hasDropsOrPenalties(r)?o.unshift(t):(e=t.consolidate(),o.unshift(e))});this.addStep("Handling drops, penalties, and bonuses",function(){var t=o[0]||new Rolls,t=n.dropPenaltyBonus(t,r);e.push(t)})}},{key:"combineRolls",value:function(t){for(r=(r=t.shift()).consolidate();t.length;)var e=(e=t.shift()).consolidate(),r=r.mergeWith(e);return r}},{key:"scheduleNextStep",value:function(){var t,e=this;this.steps.length?(t=this.steps.shift(),this.status(t),this.currentStepNumber+=1,this.timeout=setTimeout(function(){e.timeout=null,e.stepResult=t.stepFn(),e.scheduleNextStep()},100)):this.completeResults()}},{key:"completeResults",value:function(){var t=(t=this.combineRolls(this.results)).consolidate(),r=0,n=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY,i=Number.POSITIVE_INFINITY,s=Number.NEGATIVE_INFINITY,a=0,u=(t.forEach(function(t,e){t=t[0];r+=t*e,a+=e,n=Math.min(n,t),o=Math.max(o,t),i=Math.min(i,e),s=Math.max(s,e)}),r/a),l=0;t.forEach(function(t,e){t=t[0];l+=Math.abs(t-u)*e}),this.callback({avg:u,maxCount:s,maxRolls:o,minCount:i,minRolls:n,rolls:t,stdDev:l/a,stdDevTotal:l,sum:r,totalRolls:a})}},{key:"addStep",value:function(t,e){this.steps.push({message:t,stepFn:e})}}]),t}();