"use strict";function _slicedToArray(t,e){return _arrayWithHoles(t)||_iterableToArrayLimit(t,e)||_unsupportedIterableToArray(t,e)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=n){var r,i,o=[],a=!0,s=!1;try{for(n=n.call(t);!(a=(r=n.next()).done)&&(o.push(r.value),!e||o.length!==e);a=!0);}catch(t){s=!0,i=t}finally{try{a||null==n.return||n.return()}finally{if(s)throw i}}return o}}function _arrayWithHoles(t){if(Array.isArray(t))return t}function _createForOfIteratorHelper(t,e){var n,r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=_unsupportedIterableToArray(t))||e&&t&&"number"==typeof t.length)return r&&(t=r),n=0,{s:e=function(){},n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:e};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,o=!0,a=!1;return{s:function(){r=r.call(t)},n:function(){var t=r.next();return o=t.done,t},e:function(t){a=!0,i=t},f:function(){try{o||null==r.return||r.return()}finally{if(a)throw i}}}}function _toConsumableArray(t){return _arrayWithoutHoles(t)||_iterableToArray(t)||_unsupportedIterableToArray(t)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(t,e){if(t){if("string"==typeof t)return _arrayLikeToArray(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Map"===(n="Object"===n&&t.constructor?t.constructor.name:n)||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(t,e):void 0}}function _iterableToArray(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}function _arrayWithoutHoles(t){if(Array.isArray(t))return _arrayLikeToArray(t)}function _arrayLikeToArray(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=new Array(e);n<e;n++)r[n]=t[n];return r}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function _createClass(t,e,n){return e&&_defineProperties(t.prototype,e),n&&_defineProperties(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t}!function r(i,o,a){function s(e,t){if(!o[e]){if(!i[e]){var n="function"==typeof require&&require;if(!t&&n)return n(e,!0);if(u)return u(e,!0);throw(t=new Error("Cannot find module '"+e+"'")).code="MODULE_NOT_FOUND",t}n=o[e]={exports:{}},i[e][0].call(n.exports,function(t){return s(i[e][1][t]||t)},n,n.exports,r,i,o,a)}return o[e].exports}for(var u="function"==typeof require&&require,t=0;t<a.length;t++)s(a[t]);return s}({1:[function(t,e,n){window.Dice=t("./dice"),window.linkDice=t("./link-dice")},{"./dice":2,"./link-dice":4}],2:[function(t,e,n){var r=new(t("./parser")),i=new(t("./roller"));e.exports=function(){function t(){_classCallCheck(this,t),this.input="",this.isEmpty=!0,this.isWorking=!1,this.isInvalid=!1,this.min=0,this.max=0,this.avg=0,this.stdDev=0,this.result=null,this.calculatingMessage="",window.diceInstance=this}return _createClass(t,[{key:"oninit",value:function(){this.input=m.route.param("dice")||"",this.update()}},{key:"update",value:function(){var e=this,t=(this.input||"").replace(/[^-+0-9dDP,()]/g,"");if(m.route.set("/",{dice:t.trim()}),this.isEmpty=!1,this.isWorking=!1,this.isInvalid=!1,""===t)this.isEmpty=!0;else try{this.calculatingMessage="Initial setup";var n=r.parse(t);this.isWorking=!0,i.calculate(n,function(t){e.isWorking=!1,e.result=t,m.redraw()},function(t){e.calculatingMessage=t,m.redraw()})}catch(t){this.isInvalid=!0,this.invalidMessage=t.toString()}}},{key:"setInput",value:function(t){t!==this.input&&(this.input=t,this.update())}},{key:"view",value:function(){var e=this;return[m("p",["What do you want to roll?",m("br"),m("input",{type:"text",value:this.input,onchange:function(t){e.setInput(t.target.value)},disabled:this.isWorking})]),this.viewResults()]}},{key:"viewResults",value:function(){return this.isInvalid?m("p","Syntax is invalid and needs to be corrected: ".concat(this.invalidMessage)):this.isWorking?m("p","Calculating statistics: ".concat(this.calculatingMessage)):this.isEmpty?[]:[m("p",["Min: ".concat(this.result.minRolls),m("br"),"Max: ".concat(this.result.maxRolls),m("br"),"Average (Mean): ".concat(this.result.avg),m("br"),"Standard Deviation: ".concat(this.result.stdDev)]),m("table",[m("tr",[m("th","Roll"),m("th","Freq"),m("th","Prob"),m("th","Bar")])].concat(_toConsumableArray(this.viewRolls(this.result.rolls))))]}},{key:"viewRolls",value:function(){var i=this,o={width:"1%",align:"right"},a=[];return this.result.rolls.forEach(function(t,e){var t=t[0],n=e/i.result.totalRolls,r=100*e/i.result.maxCount;a.push(m("tr",[m("td",o,t),m("td",o,e),m("td",o,n),m("td",{valign:"center"},m("div",{class:"Bgc(blue) H(0.8em)",style:"width: ".concat(r.toFixed(2),"%")}))]))}),a}}]),t}()},{"./parser":5,"./roller":6}],3:[function(t,e,n){e.exports=function(){function e(t){_classCallCheck(this,e),this.input=t,this.index=0}return _createClass(e,[{key:"next",value:function(){this.index+=1}},{key:"peek",value:function(){return this.input.charAt(this.index)}},{key:"getRemainder",value:function(){return this.input.substr(this.index)}}]),e}()},{}],4:[function(t,e,n){window.addEventListener("load",function(){var e,n=_createForOfIteratorHelper(document.getElementsByClassName("linkDice"));try{for(n.s();!(e=n.n()).done;)!function(){var t=e.value;t.addEventListener("click",function(){window.diceInstance.setInput(t.innerText),m.route.set("/",{dice:t.innerText})})}()}catch(t){n.e(t)}finally{n.f()}})},{}],5:[function(t,e,n){var r=t("./input-tracker");e.exports=function(){function t(){_classCallCheck(this,t)}return _createClass(t,[{key:"parse",value:function(t){var t=new r(t),e=this.roll(t);if(""!==t.peek())throw new Error("Extra unparseable information: ".concat(t.getRemainder()));return e}},{key:"digit",value:function(t){for(var e="",n=t.peek();"0"<=n&&n<="9";)e+=n,t.next(),n=t.peek();if(0===e.length)throw new Error("Expecting a digit, found non-digit characters: ".concat(t.getRemainder()));return+e}},{key:"die",value:function(t){var e=this.digit(t);if(e<=0)throw new Error("Only positive numbers allowed for the number of dice");if("d"!==t.peek())throw new Error('Expecting "d", found: '.concat(t.getRemainder()));t.next();t=this.digit(t);if(t<=0)throw new Error("Only positive numbers allowed for the number of sides of dice");return{number:e,sides:t}}},{key:"group",value:function(t){var e={};if("("===t.peek()){if(t.next(),e.roll=this.roll(t),")"!==t.peek())throw new Error('Expecting ")", found: '.concat(t.getRemainder()));t.next()}else e.die=this.die(t);if("D"===t.peek()&&(t.next(),e.drop=this.digit(t),e.drop<=0))throw new Error("Only positive numbers allowed for the number of dice to drop");if("P"===t.peek()&&(t.next(),e.penalty=this.digit(t),e.drop<=0))throw new Error("Only positive numbers allowed for the number of dice to remove as a penalty");var n=t.peek();return"+"===n?(t.next(),e.bonus=this.digit(t)):"-"===n&&(t.next(),e.bonus=-this.digit(t)),e}},{key:"roll",value:function(t){var e=[];for(e.push(this.group(t));","===t.peek();)t.next(),e.push(this.group(t));return e}}]),t}()},{"./input-tracker":3}],6:[function(t,e,n){var s=t("./rolls");e.exports=function(){function t(){_classCallCheck(this,t),this.callback=null,this.statusCallback=null,this.startingStepCount=0,this.currentStepNumber=0,this.steps=[],this.timeout=null,this.results=[]}return _createClass(t,[{key:"status",value:function(t){this.statusCallback(t.message)}},{key:"calculate",value:function(t,e,n){this.timeout&&(clearTimeout(this.timeout),this.timeout=null),this.callback=e,this.statusCallback=n,this.steps=[],this.results=this.createSteps(t),this.scheduleNextStep()}},{key:"hasDropsOrPenalties",value:function(t){return t.drop||t.penalty}},{key:"dropPenaltyBonus",value:function(t,e){if(!this.hasDropsOrPenalties)return t.adjustBonus(e.bonus),t;var i=t.fork(),o=(i.adjustBonus(e.bonus+t.getBonus()),e.drop||0),a=e.penalty||0;return t.forEach(function(t,e){for(var n=0;n<o;n+=1)t.shift();for(var r=0;r<a;r+=1)t.pop();i.add(t,e)}),i}},{key:"createSteps",value:function(t){var e,n=[],r=_createForOfIteratorHelper(t);try{for(r.s();!(e=r.n()).done;){var i=e.value;i.roll?this.createStepsSubgroup(n,i):this.createStepsDieRoll(n,i)}}catch(t){r.e(t)}finally{r.f()}return n}},{key:"createStepsSubgroup",value:function(e,n){var r,i=this,t=this.createSteps(n.roll);this.addStep("Merging group",function(){r=i.combineRolls(t)}),this.addStep("Handling drops, penalties, and bonuses",function(){var t=i.dropPenaltyBonus(r,n);e.push(t)})}},{key:"rollDie",value:function(t){for(var e=new s,n=1;n<=t;n+=1)e.add([n],1);return e}},{key:"createStepsDieRoll",value:function(e,n){var r=this,i=[],t=n.die.sides,o=n.die.number;this.addStep("Rolling dice: ".concat(o,"d").concat(t),function(){for(;i.length<o;)i.push(r.rollDie(n.die.sides))});for(var a=1;a<o;a+=1)this.addStep("Merging ".concat(a,"d").concat(t," into ").concat(a+1,"d").concat(t),function(){var t=i.shift(),e=i.shift(),t=t.mergeWith(e);r.hasDropsOrPenalties(n)?i.unshift(t):(e=t.consolidate(),i.unshift(e))});this.addStep("Handling drops, penalties, and bonuses",function(){var t=i[0]||new s,t=r.dropPenaltyBonus(t,n);e.push(t)})}},{key:"combineRolls",value:function(t){for(n=(n=t.shift()).consolidate();t.length;)var e=(e=t.shift()).consolidate(),n=n.mergeWith(e);return n}},{key:"scheduleNextStep",value:function(){var t,e=this;this.steps.length?(t=this.steps.shift(),this.status(t),this.currentStepNumber+=1,this.timeout=setTimeout(function(){e.timeout=null,e.stepResult=t.stepFn(),e.scheduleNextStep()},100)):this.completeResults()}},{key:"completeResults",value:function(){var t=(t=this.combineRolls(this.results)).consolidate(),n=0,r=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY,o=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,s=0,u=(t.forEach(function(t,e){t=t[0];n+=t*e,s+=e,r=Math.min(r,t),i=Math.max(i,t),o=Math.min(o,e),a=Math.max(a,e)}),n/s),l=0;t.forEach(function(t,e){t=t[0];l+=Math.abs(t-u)*e}),this.callback({avg:u,maxCount:a,maxRolls:i,minCount:o,minRolls:r,rolls:t,stdDev:l/s,stdDevTotal:l,sum:n,totalRolls:s})}},{key:"addStep",value:function(t,e){this.steps.push({message:t,stepFn:e})}}]),t}()},{"./rolls":7}],7:[function(t,e,n){e.exports=function(){function e(){_classCallCheck(this,e),this.map=new Map,this.bonus=0}return _createClass(e,[{key:"add",value:function(t,e){t=t.slice(),t.sort(function(t,e){return t-e}).map(function(t){return t.toString()}),t=t.join(",");this.map.set(t,e+(this.map.get(t)||0))}},{key:"count",value:function(){return this.map.size}},{key:"forEach",value:function(t){var e,n=_createForOfIteratorHelper(this.map.entries());try{for(n.s();!(e=n.n()).done;){var r=_slicedToArray(e.value,2),i=r[0],o=r[1];t(i.split(",").map(function(t){return+t}),o)}}catch(t){n.e(t)}finally{n.f()}}},{key:"sums",value:function(){var o=this,a=new e;return this.forEach(function(t,e){var n,r=0,i=_createForOfIteratorHelper(t);try{for(i.s();!(n=i.n()).done;)r+=n.value}catch(t){i.e(t)}finally{i.f()}a.add([r+o.bonus],e)}),a}},{key:"adjustBonus",value:function(t){this.bonus+=+t||0}},{key:"getBonus",value:function(){return this.bonus}},{key:"fork",value:function(){var t=new e;return t.adjustBonus(this.bonus),t}},{key:"mergeWith",value:function(t){var i=this.fork();return this.forEach(function(n,r){t.forEach(function(t,e){i.add([].concat(_toConsumableArray(n),_toConsumableArray(t)),r*e)})}),i}},{key:"consolidate",value:function(){var o=this,a=0<arguments.length&&void 0!==arguments[0]&&arguments[0],s=new e;return this.forEach(function(t,e){var n,r=o.bonus,i=(a&&(r+=o.bonus),_createForOfIteratorHelper(t));try{for(i.s();!(n=i.n()).done;)r+=n.value}catch(t){i.e(t)}finally{i.f()}s.add([r],e)}),s}},{key:"snapshot",value:function(){return{bonus:this.bonus,map:Object.fromEntries(this.map)}}}]),e}()},{}]},{},[1]);