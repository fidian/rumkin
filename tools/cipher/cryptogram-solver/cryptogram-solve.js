"use strict";function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var a,n,i=[],s=!0,o=!1;try{for(r=r.call(e);!(s=(a=r.next()).done)&&(i.push(a.value),!t||i.length!==t);s=!0);}catch(e){o=!0,n=e}finally{try{s||null==r.return||r.return()}finally{if(o)throw n}}return i}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _createForOfIteratorHelper(e,t){var r,a="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!a){if(Array.isArray(e)||(a=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length)return a&&(e=a),r=0,{s:t=function(){},n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,i=!0,s=!1;return{s:function(){a=a.call(e)},n:function(){var e=a.next();return i=e.done,e},e:function(e){s=!0,n=e},f:function(){try{i||null==a.return||a.return()}finally{if(s)throw n}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(r="Object"===r&&e.constructor?e.constructor.name:r)||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,a=new Array(t);r<t;r++)a[r]=e[r];return a}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var a=t[r];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}var cryptogramShared=require("./cryptogram-shared"),CryptogramWord=require("./cryptogram-word"),session=require("./session"),wordlists=require("./wordlists");module.exports=function(){function e(){var n=this;_classCallCheck(this,e),this.wordlist=session.wordlist,this.wordlistMeta=null,this.parsed=null,this.letterMap=new Map,this.bestGuessStatus=-1,this.bestGuessProgress="",this.showList=0,wordlists.getWordlists().then(function(e){var t,r=_createForOfIteratorHelper(e);try{for(r.s();!(t=r.n()).done;){var a=t.value;if(a.filename===n.wordlist)return n.wordlistMeta=a,void n.loadWordlist()}}catch(e){r.e(e)}finally{r.f()}m.route.set("/")})}return _createClass(e,[{key:"keyWord",value:function(e){var r=65,a=0,n=new Map;return{key:e.split("").map(function(e){var t=n.get(e);return t||(t=r,n.set(e,t),r+=1,a+=1),String.fromCharCode(t)}).join(""),letterCount:a}}},{key:"keyWordlist",value:function(e){var t,r={},a=_createForOfIteratorHelper(e);try{for(a.s();!(t=a.n()).done;){var n=t.value,i=this.keyWord(n).key,s=r[i];s||(s=[],r[i]=s),s.push(n)}}catch(e){a.e(e)}finally{a.f()}return r}},{key:"upper",value:function(e){return e.toUpperCase().replace(/ß/g,"ẞ")}},{key:"isLetter",value:function(e){return!!e.match(/['·A-ZÀÁÂÄÅÃĄÆĈÇĆČÐĐÈÉÊËĘĜĤÌÍÎÏĴŁÑŃÒÓÔÖÕØŜŚŠŞẞÙÚÛÜŬÝŹŻАБВГҐДЕЄЖЗИІЇЙКЛМНОПРСТУФХЦЧШЩЪЬЮЯ]/)}},{key:"incrementShowingIndex",value:function(e){for(var t=e.length-1;0<=t;){var r=e[t];if(r.showingIndex+=1,!(r.showingIndex>=r.availableMatches.length))return!0;r.showingIndex=0,--t}return!1}},{key:"parseWords",value:function(e){var t,r=[],a=null,n=_createForOfIteratorHelper(this.upper(session.cipherText).split(""));try{for(n.s();!(t=n.n()).done;){var i=t.value,s=this.isLetter(i);a&&a.isLetter===s?a.chars+=i:(a={chars:i,isLetter:s},r.push(a))}}catch(e){n.e(e)}finally{n.f()}for(var o=0,l=r;o<l.length;o++){var u,c,h=l[o];h.isLetter&&(u=(c=this.keyWord(h.chars)).key,c=c.letterCount,h.key=u,h.letterCount=c,h.rawMatches=e[h.key]||[],h.showingIndex=0)}return r}},{key:"reset",value:function(){var e,t=_createForOfIteratorHelper(this.parsed);try{for(t.s();!(e=t.n()).done;){var r=e.value;r.isLetter&&(r.availableMatches=_toConsumableArray(r.rawMatches),r.selectedWord="",r.isLoaded=!1)}}catch(e){t.e(e)}finally{t.f()}this.letterMap=new Map,this.bestGuessStatus=1,this.deduce([]);var a,n=_createForOfIteratorHelper(this.parsed);try{for(n.s();!(a=n.n()).done;){var i=a.value;!i.selectedWord&&i.isLetter&&(this.bestGuessStatus=-1)}}catch(e){n.e(e)}finally{n.f()}}},{key:"loadWordlist",value:function(){var t=this;wordlists.getWordlist(this.wordlistMeta.filename).then(function(e){e=t.keyWordlist(e);t.parsed=t.parseWords(e),t.reset()})}},{key:"deduce",value:function(a){function e(){var e,t=_createForOfIteratorHelper(n.parsed);try{for(t.s();!(e=t.n()).done;){var r=e.value;r.isLetter&&(n.updateAvailableMatches(r),1!==r.availableMatches.length||r.selectedWord||(r.selectedWord=r.availableMatches[0],a.push([r.chars,r.selectedWord])))}}catch(e){t.e(e)}finally{t.f()}}var n=this;for(e();a.length;){for(var t=_slicedToArray(a.shift(),2),r=t[0],i=t[1],s=0;s<r.length;s+=1)this.letterMap.set(r.charAt(s),i.charAt(s));e()}}},{key:"makePattern",value:function(e,t){var r=_toConsumableArray(this.letterMap.values()).join(""),a=r?"[^".concat(r,"]"):".",r=e.split("").map(function(e){return t.get(e)||a}).join("");return new RegExp("^".concat(r,"$"))}},{key:"updateAvailableMatches",value:function(e){var t=this.makePattern(e.chars,this.letterMap);e.availableMatches=e.availableMatches.filter(function(e){return e.match(t)})}},{key:"sortParsedWords",value:function(){return this.parsed.filter(function(e){return e.isLetter}).sort(function(e,t){var r=e.letterCount-t.letterCount;if(r)return r;r=e.availableMatches.length;return t.availableMatches.length-r})}},{key:"startBestGuess",value:function(){var e,t=this.sortParsedWords(),r=_createForOfIteratorHelper(t);try{for(r.s();!(e=r.n()).done;)e.value.hits=new Set}catch(e){r.e(e)}finally{r.f()}var a=t.pop(),a={current:this.makeCurrentState(a,"",""),earlier:[],next:t};this.processState(a)}},{key:"makeCurrentState",value:function(e,t,r,a){for(var n=new Map(t),i=0;i<r.length;i+=1)n.set(r.charAt(i),a.charAt(i));return{index:0,item:e,map:n,pattern:this.makePattern(e.chars,n)}}},{key:"processState",value:function(e){for(var t=this,r=Date.now();r+200>Date.now();)if(e.current.index>=e.current.item.availableMatches.length){if(e.next.push(e.current.item),e.current=e.earlier.pop(),!e.current)return void this.finishBestGuess(e.next);e.current.index+=1}else{for(;e.current.index<e.current.item.availableMatches.length&&!e.current.item.availableMatches[e.current.index].match(e.current.pattern);)e.current.index+=1;if(e.current.index<e.current.item.availableMatches.length)if(e.next.length){var a=e.current,n=(e.earlier.push(a),e.next.pop());e.current=this.makeCurrentState(n,a.map,a.item.chars,a.item.availableMatches[a.index])}else{var i,s=_createForOfIteratorHelper(e.earlier);try{for(s.s();!(i=s.n()).done;){var o=i.value;o.item.hits.add(o.item.availableMatches[o.index])}}catch(e){s.e(e)}finally{s.f()}e.current.index+=1}}this.bestGuessProgress=this.makeBestGuessProgress(e),setTimeout(function(){t.processState(e),m.redraw()},1)}},{key:"makeBestGuessProgress",value:function(e){var t,r=[],a=_createForOfIteratorHelper(e.earlier);try{for(a.s();!(t=a.n()).done;){var n=t.value;r.push("[".concat(n.index,"/").concat(n.item.availableMatches.length,"]"))}}catch(e){a.e(e)}finally{a.f()}return r.push("[".concat(e.current.index,"/").concat(e.current.item.availableMatches.length,"]")),r.join(" ")}},{key:"finishBestGuess",value:function(e){var a,n=0,i=0,s=0,o=0,t=_createForOfIteratorHelper(e);try{for(t.s();!(a=t.n()).done;)!function(){var e,t,r=a.value;n+=1,r.hits.size?(i+=1,e=r.availableMatches.length,r.availableMatches=r.availableMatches.filter(function(e){return r.hits.has(e)}),t=r.availableMatches.length,o=e-t):s+=1,delete r.hits}()}catch(e){t.e(e)}finally{t.f()}this.bestGuessStatus=1,this.bestGuessProgress=s===n?"The words in this dictionary are unable to decode this message. Try a larger dictionary or perhaps attempt to pick words yourself to find a solution.":"Updated ".concat(i," out of ").concat(n," words and removed ").concat(o," possibilities."),this.deduce([])}},{key:"view",value:function(){return[cryptogramShared.viewCipherText(),m("p",this.viewWordlist()),this.viewBestGuess(),this.viewParsed(),m("p",this.viewButtons()),this.viewList()]}},{key:"viewWordlist",value:function(){return this.wordlistMeta?m("p",[m("b","Wordlist:")," ".concat(this.wordlistMeta.name)]):"Loading list of wordlists"}},{key:"viewBestGuess",value:function(){var e=this;return 0<this.bestGuessStatus||!this.parsed||!this.parsed.length?m("p",this.bestGuessProgress):0===this.bestGuessStatus?m("p","Working on eliminating conflicting words ... ".concat(this.bestGuessProgress)):m("p",[m("button",{onclick:function(){return e.bestGuessStatus=0,e.startBestGuess(),!1}},"Eliminate Bad Combinations")," This can take a significant amount of time. Removes words from the lists that can not work with other cipher words. This will often help you find the deciphered text much quicker, but the entire cipher text consist of dictionary words."])}},{key:"viewParsed",value:function(){var r=this;return this.parsed?this.parsed.length?0===this.bestGuessStatus?null:m("div",{class:"D(f) Fxw(w)"},this.parsed.map(function(e){return m(CryptogramWord,{data:e,letterMap:r.letterMap,setLetters:function(e,t){return r.deduce([[e,t]])}})})):"Nothing to decrypt":"Loading dictionary..."}},{key:"viewButtons",value:function(){var e=this;return[m("button",{onclick:function(){m.route.set("/")}},"Go Back"),m("button",{disabled:!this.parsed||!this.parsed.length||0===this.bestGuessStatus,onclick:function(){e.reset()}},"Reset Options")]}},{key:"viewList",value:function(){if(!this.parsed||0===this.bestGuessStatus)return[];var e,t=1,r=_createForOfIteratorHelper(this.parsed);try{for(r.s();!(e=r.n()).done;){var a=e.value;a.isLetter&&(t*=a.availableMatches.length)}}catch(e){r.e(e)}finally{r.f()}return 1e6<t?m("p","There are too many possibilities. Viewing the options has been disabled until you can narrow down the options."):[this.viewListWords(),this.viewListButton(t)]}},{key:"viewListWords",value:function(){if(!this.showList)return[];var e,t=_createForOfIteratorHelper(this.parsed);try{for(t.s();!(e=t.n()).done;)e.value.showingIndex=0}catch(e){t.e(e)}finally{t.f()}for(var r=this.sortParsedWords(),a=0,n=[];a<this.showList;)if(n.push(this.viewSingleListEntry()),a+=1,!this.incrementShowingIndex(r))return n;return n}},{key:"viewSingleListEntry",value:function(){var e=this.parsed.map(function(e){return e.isLetter?e.selectedWord||e.availableMatches[e.showingIndex]:e.chars});return m("div",{class:"My(0.25em)"},e.join(""))}},{key:"viewListButton",value:function(e){var t=this;if(e<=this.showList)return m("p","No further solutions exist with this dictionary.");return m("p",m("button",{onclick:function(){t.showList+=1e3}},this.viewListButtonLabel(e,1e3)))}},{key:"viewListButtonLabel",value:function(e,t){return 0===this.showList&&e<=t?"Show all ".concat(e.toLocaleString()," solutions"):this.showList+t>e?"Show remaining ".concat((e-this.showList).toLocaleString()," solutions"):(0===this.showList?"Show first ":"Show next ").concat(t.toLocaleString()," solutions out of ").concat(e.toLocaleString())}}]),e}();