<html><head><title>JavaScript compression</title>
<script language="JavaScript" src="/inc/js/browser_faster.js"></script>
<script language="JavaScript">
// This is the list of usable characters for command characters and
// replacements.  Avoid ones that need to be quoted again, such as "
// and newlines, and \
var Chars = " !#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ" +
      "[]^_`abcdefghijklmnopqrstuvwxyz{|}~";
var CommandChar;
var CommandReplacement;
var Prog;
var ToBeCompressed;


function StringReplace(From, To, String) {
   var S = String.split(From);
   var out = new StringMaker();
   out.append(S[0]);
   for (var i = 1; i < S.length; i ++) {
	   out.append(To + S[i]);
   }
   return out.toString();
}

function AlterNewlines() {
   AddProgress("Altering newlines");
   ToBeCompressed = StringReplace("\r\n", "\n", ToBeCompressed);
   ToBeCompressed = StringReplace("\r", "\n", ToBeCompressed);
}   

function UpdateCompressionStats(newLen) {
   var percent;
   percent = newLen / daForm.Orig.value.length;
   percent = 1 - percent;
   percent *= 1000;
   percent = Math.floor(percent);
   percent /= 10;
   daForm.Percent.value = "" + percent + "%";
}

function UpdateProgress(i, Pass) {
   Prog = "Length " + i + ", Pass " + Pass;
   window.status = Prog;
}

function AddProgress(str) {
   window.status = Prog + " [" + str + "]";
}

function FindCommandChar() {
   var j, i;
   AddProgress("Locating command character");
   for (i = 0; i < Chars.length; i ++) {
      j = ToBeCompressed.indexOf(Chars.charAt(i));
      if (j == -1) {
         CommandChar = Chars.charAt(i);
         CommandReplacement = 0;
         AlterNewlines();
         ReplacedWith = ReplaceCompChars("\n");
         return new Array(ReplacedWith, "\n");
      }
   }
   AddProgress("Locating least frequently used character");
   var Hits = new Array(Chars.length);
   for (i = 0; i < Hits.length; i ++) {
      Hits[i] = 0;
   }
   for (i = 0; i < ToBeCompressed.length; i ++) {
      j = Chars.indexOf(ToBeCompressed.charAt(i));
      if (j != -1) {
         Hits[j] ++;
      }
   }
   j = 0;
   for (i = 1; i < Hits.length; i ++) {
      if (Hits[i] < Hits[j]) {
         j = i;
      }
   }
   CommandChar = Chars.charAt(j);
   CommandReplacement = 0;
   AlterNewlines();
   ReplacedWith = ReplaceCompChars(CommandChar);
   ReplacedWith2 = ReplaceCompChars("\n");
   return new Array(ReplacedWith, CommandChar, ReplacedWith2, "\n");
}

function ReplaceCompChars(From) {
   var RW, Ch;
   AddProgress("Compressing");
   RW = CommandReplacement;
   ReplacedWith = "";
   while (RW) {
      Ch = Math.floor(RW / Chars.length);
      RW -= (Ch * Chars.length);
      ReplacedWith += Chars.charAt(RW);
      RW = Ch;
   }
   ToBeCompressed = StringReplace(From, CommandChar + ReplacedWith + CommandChar, ToBeCompressed);
   CommandReplacement ++;
   return ReplacedWith;
}

function FindBestMatch(size) {
   var i, j, Found, Str;
   var HitsChars = new Array();
   var HitsLastMatch = new Array();
   var HitsHits = new Array();
   for (i = 0; i < ToBeCompressed.length - size + 1; i ++) {
      if (i - (Math.floor(i / 50) * 50) == 0) {
         AddProgress("Finding best replacement (" + Math.floor ((i / (ToBeCompressed.length - size + 1)) * 1000) / 10 + "%)");
      }
      Found = -1;
      Str = ToBeCompressed.substr(i, size);
      for (j = 0; j < HitsHits.length; j ++) {
         if (HitsChars[j] == Str) {
            Found = j;
         }
      }
      if (Found != -1) {
         if (HitsLastMatch[Found] + size < i) {
            HitsHits[Found] ++;
         }
      } else {
         NewHitsChars = new Array(HitsChars.length + 1);
         NewHitsLastMatch = new Array(HitsLastMatch.length + 1);
         NewHitsHits = new Array(HitsHits.length + 1);
         for (var j = 0; j < HitsHits.length; j ++) {
            NewHitsChars[j] = HitsChars[j];
            NewHitsLastMatch[j] = HitsLastMatch[j];
            NewHitsHits[j] = HitsHits[j];
         }
         NewHitsChars[j] = Str;
         NewHitsLastMatch[j] = i;
         NewHitsHits[j] = 1;
         HitsChars = NewHitsChars;
         HitsLastMatch = NewHitsLastMatch;
         HitsHits = NewHitsHits;
      }
   }
   j = 0;
   for (i = 1; i < HitsChars.length; i ++) {
      if (HitsHits[j] < HitsHits[i]) {
         j = i;
      }
   }
   return new Array(HitsChars[j], HitsHits[j]);
}
         

function MakeIntoString(S) {
   S = StringReplace("\\", "\\\\", S);
   S = StringReplace("\"", "\\\"", S);
   S = StringReplace("\n", "\\n", S);
   return S;
}

function Chopper(S) {
   var Result;
   Result = "";
   while (S.length > 70) {
      Result += S.substr(0, 70);
      Result += "\"+\n\"";
      S = S.substr(70);
   }
   return Result + S;
}

function CompressMakeSure() {
   if (confirm("Are you sure that you want to do this?  It can take a long time!")) {
      CompressCode();
   }
}

function CompressCode() {
   var Replacements;
   ToBeCompressed = daForm.Orig.value;
   Replacements = new Array();
   UpdateProgress(ToBeCompressed.length, 0);
   FindCommandChar();
   var sz = 4;
   UpdateProgress(ToBeCompressed.length, sz);
   BestMatch = FindBestMatch(sz);
   while (BestMatch[1] > 3) {
      UpdateProgress(ToBeCompressed.length, sz);
      sz ++;
      BestMatch = FindBestMatch(sz);
   }   
   for (; sz > 3; sz --) {
      UpdateProgress(sz, 0);
      BestMatch = FindBestMatch(sz);
      Pass = 0;
      while (BestMatch[1] > 3) {
         ReplacedWith = ReplaceCompChars(BestMatch[0]);
         
         var NewReplacements = new Array(Replacements.length + 2);
         for (j = 0; j < Replacements.length; j ++) {
            NewReplacements[j + 2] = Replacements[j];
         }
         Replacements = NewReplacements;
         Replacements[0] = ReplacedWith;
         Replacements[1] = BestMatch[0];
         
         Pass ++;
         UpdateProgress(sz, Pass);
         BestMatch = FindBestMatch(sz);
      }
   }
   UpdateCompressionStats(ToBeCompressed.length);
   AddProgress("Creating javascript");
   var S = "R=new Array(";
   BigAss = "";
   for (i = Replacements.length - 2; i >= 0; i -= 2) {
      BigAss += "\"" + MakeIntoString(Replacements[i]) + "\",\"" +
         MakeIntoString(Replacements[i + 1]) + "\"";
      if (i != 0) {
         BigAss += ",";
      }
      if (BigAss.length > 70) {
         S += BigAss + "\n";
         BigAss = "";
      }
   }
   S += BigAss + ");\n";
   S += "S=\"" + Chopper(MakeIntoString(ToBeCompressed)) + "\";\n";
   S += "for(i=0;i<R.length;i+=2){\n";
   S += "   A=S.split(R[i]);\n";
   S += "   S=A[0];\n";
   S += "   for(j=1;j<A.length;j++){\n";
   S += "      S+=R[i+1]+A[j];\n";
   S += "   }\n";
   S += "}\n";
   S += "eval(S);\n";
   daForm.Comp.value = S;
   window.status = "Done.";
      if (ToBeCompressed.length >= daForm.Orig.value.length) {
         alert("No useful compression could be performed.  Sorry.");
      }
}

</script>
</head>
<body bgcolor="#FFFFFF">
<h1 align=center>JavaScript Web Page Compression</h1>

<p>Ever want your web page code compressed?  Enter your HTML or JavaScript here and
I'll compress it for you!  It's not that great of compression -- it uses character
tokenizing, but it'll work.</p>

<form name="daForm">
<P><B>Original:</b></p>
<textarea name="Orig" rows=10 cols=60>aaaaaaabbbbbbbbbbbbbbbbbbbbbb
bbbbbbbbbbbbbbbbbbbbbbbbbbbb
bbbbbbbbbbbccddddeeeeffgghhhiijjjjkk</textarea>
<br>
<input type=button onClick="CompressMakeSure()" value="Compress Code!"><br>
<B>Compressed by:</b> <input type=text size=40 name="Percent"></p>
<p><B>Compressed:</B></p>
<textarea name="Comp" rows=10 cols=60></textarea>
</form>
